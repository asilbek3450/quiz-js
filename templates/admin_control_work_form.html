{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold mb-0">
                {% if control_work %}{{ _('Nazorat ishini tahrirlash') }}{% else %}{{ _('Yangi nazorat ishi') }}{% endif
                %}
            </h2>
            <a href="{{ url_for('admin.control_works') }}" class="btn btn-outline-secondary rounded-pill px-4">
                <i class="fas fa-arrow-left me-2"></i>{{ _('Orqaga') }}
            </a>
        </div>

        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body p-4 p-md-5">
                <form method="POST"
                    action="{% if control_work %}{{ url_for('admin.control_work_edit', id=control_work.id) }}{% else %}{{ url_for('admin.control_work_add') }}{% endif %}">

                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-muted small text-uppercase">{{ _('Nazorat ishi nomi')
                                }}</label>
                            <input type="text" name="title" class="form-control form-control-lg bg-light border-0"
                                value="{{ control_work.title if control_work else '' }}" required
                                placeholder="Masalan: 8-sinf Choraklik Baholash">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold text-muted small text-uppercase">{{ _('Fan') }}</label>
                            <select name="subject_id" class="form-select form-select-lg bg-light border-0" required
                                id="subjectSelect">
                                <option value="">{{ _('Fanni tanlang') }}</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}" {% if control_work and
                                    control_work.subject_id==subject.id %}selected{% endif %}>
                                    {{ subject.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold text-muted small text-uppercase">{{ _('Sinf') }}</label>
                            <input type="number" name="grade" id="gradeSelect"
                                class="form-control form-control-lg bg-light border-0"
                                value="{{ control_work.grade if control_work else '' }}" required min="1" max="11">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold text-muted small text-uppercase">{{ _('Chorak') }}</label>
                            <select name="quarter" id="quarterSelect"
                                class="form-select form-select-lg bg-light border-0" required>
                                <option value="">{{ _('Tanlang') }}</option>
                                {% for i in range(1, 5) %}
                                <option value="{{ i }}" {% if control_work and control_work.quarter==i %}selected{%
                                    endif %}>{{ i }}-{{ _('chorak') }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold text-muted small text-uppercase">{{ _('Vaqt (daqiqada)')
                                }}</label>
                            <input type="number" name="time_limit"
                                class="form-control form-control-lg bg-light border-0"
                                value="{{ control_work.time_limit if control_work else 40 }}" required min="5">
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="form-check form-switch form-check-lg">
                            <input class="form-check-input" type="checkbox" role="switch" id="isActive" name="is_active"
                                {% if not control_work or control_work.is_active %}checked{% endif %}
                                style="transform: scale(1.3); margin-right: 15px; margin-top: 5px;">
                            <label class="form-check-label fw-bold ms-2" for="isActive">{{ _('Aktiv holatda
                                (o\'quvchilarga ko\'rinadi)') }}</label>
                        </div>
                    </div>

                    <hr class="my-5 opacity-10">

                    <h5 class="fw-bold mb-4">{{ _('Savollarni tanlang') }}</h5>
                    <p class="text-muted small mb-4">{{ _('Mavjud savollardan nazorat ishiga tushirmoqchi
                        bo\'lganlaringizni belgilang. Qulaylik uchun fan, sinf va chorak bo\'yicha ro\'yxat avtomatik
                        yangilanadi.') }}</p>

                    <div class="card bg-light border-0 rounded-4">
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;" id="questionsContainer">
                            <div class="text-center py-4 text-muted" id="loadingQuestions" style="display: none;">
                                <i class="fas fa-spinner fa-spin me-2"></i> {{ _('Savollar yuklanmoqda...') }}
                            </div>
                            <div id="questionsList">
                                <!-- Ajax loaded questions will appear here -->
                            </div>
                        </div>
                    </div>

                    <div class="mt-5 d-flex gap-2 justify-content-end">
                        <a href="{{ url_for('admin.control_works') }}"
                            class="btn btn-light btn-lg px-4 rounded-pill fw-bold">{{ _('Bekor qilish') }}</a>
                        <button type="submit" class="btn btn-primary btn-lg px-5 rounded-pill fw-bold shadow-sm">
                            <i class="fas fa-save me-2"></i>{{ _('Saqlash') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .question-item {
        transition: all 0.2s;
        border: 2px solid transparent;
    }

    .question-item:hover {
        background-color: white;
        border-color: var(--primary);
    }

    .form-check-input:checked+.form-check-label {
        color: var(--primary);
        font-weight: bold;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const subjectSelect = document.getElementById('subjectSelect');
        const gradeSelect = document.getElementById('gradeSelect');
        const quarterSelect = document.getElementById('quarterSelect');
        const questionsList = document.getElementById('questionsList');
        const loadingQuestions = document.getElementById('loadingQuestions');

        // Default selected questions for edit mode
        const selectedQuestionIds = [
            {% if control_work %}
            {% for q in control_work.questions %}{ { q.id } }, {% endfor %}
    {% endif %}
    ];

    function fetchQuestions() {
        const subject_id = subjectSelect.value;
        const grade = gradeSelect.value;
        const quarter = quarterSelect.value;

        if (!subject_id || !grade || !quarter) {
            questionsList.innerHTML = `<div class="text-center py-4 text-muted">{{ _("Savollarni ko'rish uchun Fan, Sinf va Chorakni tanlang.") }}</div>`;
            return;
        }

        loadingQuestions.style.display = 'block';
        questionsList.innerHTML = '';

        fetch(`{{ url_for('admin.api_get_questions') }}?subject_id=${subject_id}&grade=${grade}&quarter=${quarter}`)
            .then(response => response.json())
            .then(data => {
                loadingQuestions.style.display = 'none';

                if (data.questions.length === 0) {
                    questionsList.innerHTML = `<div class="text-center py-4 text-warning"><i class="fas fa-exclamation-circle me-2"></i>{{ _("Ushbu mezonlar bo'yicha savollar topilmadi.") }}</div>`;
                    return;
                }

                data.questions.forEach(q => {
                    const isChecked = selectedQuestionIds.includes(q.id) ? 'checked' : '';
                    const item = document.createElement('div');
                    item.className = 'question-item bg-white p-3 rounded-3 mb-2 shadow-sm cursor-pointer d-flex align-items-start gap-3';

                    item.innerHTML = `
                        <div class="form-check mt-1">
                            <input class="form-check-input" type="checkbox" name="question_ids" value="${q.id}" id="q_${q.id}" ${isChecked} style="transform: scale(1.3);">
                        </div>
                        <div class="flex-grow-1">
                            <label class="form-check-label d-block cursor-pointer mb-2" for="q_${q.id}">
                                <strong>ID: #${q.id}</strong> - ${q.text}
                            </label>
                            <div class="d-flex gap-2 flex-wrap">
                                <span class="badge ${q.correct == 'A' ? 'bg-success' : 'bg-light text-dark'}">A) ${q.a}</span>
                                <span class="badge ${q.correct == 'B' ? 'bg-success' : 'bg-light text-dark'}">B) ${q.b}</span>
                                <span class="badge ${q.correct == 'C' ? 'bg-success' : 'bg-light text-dark'}">C) ${q.c}</span>
                                <span class="badge ${q.correct == 'D' ? 'bg-success' : 'bg-light text-dark'}">D) ${q.d}</span>
                            </div>
                        </div>
                    `;
                    questionsList.appendChild(item);
                });
            })
            .catch(err => {
                loadingQuestions.style.display = 'none';
                questionsList.innerHTML = `<div class="text-center py-4 text-danger"><i class="fas fa-times-circle me-2"></i>{{ _("Xatolik yuz berdi.") }}</div>`;
            });
    }

    subjectSelect.addEventListener('change', fetchQuestions);
    gradeSelect.addEventListener('input', fetchQuestions); // using input for number field
    quarterSelect.addEventListener('change', fetchQuestions);

    // Initial fetch if editing
    {% if control_work %}
    fetchQuestions();
    {% endif %}
});
</script>
{% endblock %}