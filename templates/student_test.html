{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center no-select-zone">
    <div class="col-lg-8">
        <!-- Progress Info -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <span class="text-muted small text-uppercase fw-bold">{{ _('Savol') }}</span>
                <div class="h3 mb-0 fw-bold">{{ current }} <span class="text-muted h5">/ {{ total }}</span></div>
            </div>
            <div class="text-end">
                <span class="text-muted small text-uppercase fw-bold">{{ _('Vaqt') }}</span>
                <div class="h4 mb-0 fw-bold text-primary" id="timer">30:00</div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress mb-5" style="height: 8px;">
            <div class="progress-bar" role="progressbar" style="width: {{ (current / total) * 100 }}%"></div>
        </div>

        <!-- Question Card -->
        <div class="card border-0 shadow-lg mb-4 animate-scale-in">
            <div class="card-body p-4 p-md-5">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div class="question-text text-dark user-select-none flex-grow-1">
                        <div class="lh-base fw-bold fs-5">{{ question_text | markdown | safe }}</div>
                    </div>
                    <button type="button" id="mark-btn" onclick="toggleMark('{{ question.id }}')"
                        class="btn {{ 'btn-warning' if question.id in marked_questions else 'btn-outline-warning' }} ms-3 shadow-sm animate-scale-in"
                        title="{{ _('Qayta ko\'rish uchun belgilash') }}">
                        <i class="{{ 'fas' if question.id in marked_questions else 'far' }} fa-bookmark"></i>
                    </button>
                </div>

                <div class="options-list">
                    <div class="row g-3">
                        {% set visual_labels = ['A', 'B', 'C', 'D'] %}
                        {% for option in options %}
                        {% set visual_label = visual_labels[loop.index0] %}
                        <div class="col-12">
                            <input type="radio" class="btn-check" name="answer" id="opt{{ option.key }}"
                                value="{{ option.key }}" {% if answers.get(question.id|string)==option.key %}checked{%
                                endif %} onchange="submitAnswer('{{ question.id }}', '{{ option.key }}')">
                            <label
                                class="btn btn-outline-light text-dark text-start w-100 p-3 border-2 option-label d-flex align-items-center"
                                for="opt{{ option.key }}">
                                <span
                                    class="option-key rounded-circle d-flex align-items-center justify-content-center me-3 border fw-bold">{{
                                    visual_label }}</span>
                                <span class="option-text fs-5">{{ option.value }}</span>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="d-flex justify-content-between mt-4">
            {% if current > 1 %}
            <a href="{{ url_for('student.navigate', direction='prev') }}" class="btn btn-light px-4 py-3">
                <i class="fas fa-arrow-left me-2"></i> {{ _('Oldingi') }}
            </a>
            {% else %}
            <div></div>
            {% endif %}

            {% if current < total %} <a href="{{ url_for('student.navigate', direction='next') }}"
                class="btn btn-primary px-4 py-3">
                {{ _('Keyingi') }} <i class="fas fa-arrow-right ms-2"></i>
                </a>
                {% else %}
                <button type="button" class="btn btn-success px-4 py-3" data-bs-toggle="modal"
                    data-bs-target="#finishModal">
                    <i class="fas fa-check-circle me-2"></i> {{ _('Yakunlash') }}
                </button>
                {% endif %}
        </div>
    </div>

    <!-- Navigation Sidebar (Desktop) -->
    <div class="col-lg-4 d-none d-lg-block">
        <div class="card border-0 shadow-lg sticky-top" style="top: 2rem;">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0 fw-bold text-uppercase small text-muted"><i class="fas fa-th me-2"></i> {{ _('Savollar
                    xaritasi') }}</h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    {% for i in range(total) %}
                    {% set q_id = question_ids[i] | string %}
                    {% set is_current = (i + 1) == current %}
                    {% set is_answered = q_id in answers %}
                    {% set is_marked = question_ids[i] in marked_questions %}

                    <div class="col-3">
                        <a href="{{ url_for('student.jump', index=i) }}"
                            class="btn w-100 p-2 fw-bold position-relative
                               {{ 'btn-primary text-white shadow' if is_current else 
                                  ('btn-warning text-dark' if is_marked else
                                  ('btn-success text-white' if is_answered else 'btn-outline-light text-dark border-2')) }}"
                            style="{{ 'border-color: #e2e8f0;' if not is_current and not is_answered and not is_marked }}">
                            {{ i + 1 }}
                            {% if is_marked %}
                            <span
                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                style="padding: 0.35em 0.5em; font-size: 0.6em; z-index: 1;">
                                <i class="fas fa-bookmark"></i>
                            </span>
                            {% endif %}
                        </a>
                    </div>
                    {% endfor %}
                </div>

                <div class="mt-4 pt-3 border-top">
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-primary rounded-circle p-1 me-2" style="width:12px; height:12px;"></span>
                        <small class="text-muted">{{ _('Joriy savol') }}</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-success rounded-circle p-1 me-2" style="width:12px; height:12px;"></span>
                        <small class="text-muted">{{ _('Belgilangan') }}</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-warning rounded-circle p-1 me-2" style="width:12px; height:12px;"></span>
                        <small class="text-muted">{{ _('Qayta ko\'rish uchun') }}</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-light border rounded-circle p-1 me-2"
                            style="width:12px; height:12px;"></span>
                        <small class="text-muted">{{ _('Belgilanmagan') }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Navigation Toggle -->
<div class="d-lg-none fixed-bottom p-3" style="z-index: 1000; pointer-events: none;">
    <button class="btn btn-dark shadow-lg rounded-circle p-3" style="pointer-events: auto; float: right;" type="button"
        data-bs-toggle="offcanvas" data-bs-target="#mobileMap">
        <i class="fas fa-th fa-lg"></i>
    </button>
</div>

<!-- Mobile Offcanvas Map -->
<div class="offcanvas offcanvas-bottom h-75 rounded-top" tabindex="-1" id="mobileMap" aria-labelledby="mobileMapLabel">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold" id="mobileMapLabel">{{ _('Savollar xaritasi') }}</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div class="row g-2">
            {% for i in range(total) %}
            {% set q_id = question_ids[i] | string %}
            {% set is_current = (i + 1) == current %}
            {% set is_answered = q_id in answers %}
            {% set is_marked = question_ids[i] in marked_questions %}

            <div class="col-3 col-sm-2">
                <a href="{{ url_for('student.jump', index=i) }}"
                    class="btn w-100 p-3 fw-bold position-relative
                            {{ 'btn-primary text-white shadow' if is_current else 
                               ('btn-warning text-dark' if is_marked else 
                               ('btn-success text-white' if is_answered else 'btn-outline-light text-dark border-2')) }}"
                    style="{{ 'border-color: #e2e8f0;' if not is_current and not is_answered and not is_marked }}">
                    {{ i + 1 }}
                    {% if is_marked %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                        style="z-index: 1;">
                        <i class="fas fa-bookmark small"></i>
                    </span>
                    {% endif %}
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
    /* ANTI-COPY PROTECTION */
    .no-select-zone,
    body {
        -webkit-user-select: none;
        /* Safari */
        -moz-user-select: none;
        /* Firefox */
        -ms-user-select: none;
        /* IE10+/Edge */
        user-select: none;
        /* Standard */
    }

    .option-label {
        border-color: #e2e8f0;
        transition: all 0.2s ease;
        background: white;
    }

    .option-label:hover {
        background: #f8fafc;
        border-color: var(--primary);
        transform: translateX(5px);
        color: var(--dark) !important;
    }

    .option-key {
        width: 32px;
        height: 32px;
        min-width: 32px;
        font-size: 0.9rem;
        background: #f1f5f9;
        transition: all 0.2s ease;
    }

    .btn-check:checked+.option-label {
        background: rgba(99, 102, 241, 0.1);
        border-color: var(--primary);
        color: var(--primary) !important;
        font-weight: 600;
    }

    .btn-check:checked+.option-label .option-key {
        background: var(--primary);
        color: white;
        border-color: var(--primary) !important;
    }

    /* Premium Polish */
    .card {
        border-radius: 24px;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95);
    }
</style>

<!-- Finish Confirmation Modal -->
<div class="modal fade" id="finishModal" tabindex="-1" aria-labelledby="finishModalLabel" aria-hidden="true"
    data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
            <div class="modal-header bg-success text-white border-0 py-3">
                <h5 class="modal-title fw-bold" id="finishModalLabel"><i class="fas fa-check-circle me-2"></i> {{
                    _('Testni yakunlash') }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="mb-3 text-success">
                    <i class="fas fa-clipboard-check fa-4x animate-scale-in"></i>
                </div>
                <h4 class="fw-bold mb-3">{{ _('Rostdan ham testni yakunlamoqchimisiz?') }}</h4>
                <div class="row g-3 mb-4">
                    <div class="col-4">
                        <div class="p-2 border rounded bg-white">
                            <div class="h4 mb-0 text-success fw-bold">{{ answers|length }}</div>
                            <small class="text-muted">{{ _('Yechilgan') }}</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-2 border rounded bg-white">
                            <div class="h4 mb-0 text-warning fw-bold">{{ marked_questions|length }}</div>
                            <small class="text-muted">{{ _('Belgilangan') }}</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-2 border rounded bg-white">
                            <div class="h4 mb-0 text-danger fw-bold">{{ total - answers|length }}</div>
                            <small class="text-muted">{{ _('Qolgan') }}</small>
                        </div>
                    </div>
                </div>
                <p class="text-muted mb-0 small">{{ _('Yakunlash tugmasini bosgandan so\'ng natijalaringiz
                    hisoblanadi.') }}</p>
                {% if answers|length < total %} <div class="alert alert-warning border-0 small mt-3 mb-0">
                    <i class="fas fa-exclamation-triangle me-1"></i> {{ _('Siz barcha savollarga javob bermadingiz!') }}
            </div>
            {% endif %}
        </div>
        <div class="modal-footer border-0 bg-light p-3 justify-content-center">
            <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal">{{ _('Yo\'q, qaytish')
                }}</button>
            <a href="{{ url_for('student.navigate', direction='finish') }}"
                class="btn btn-success px-5 py-2 fw-bold shadow-sm">
                {{ _('Ha, yakunlash') }} <i class="fas fa-arrow-right ms-2"></i>
            </a>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Protection Overlay -->
<div id="violation-overlay"
    style="display: {{ 'flex' if is_blocked else 'none' }}; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #e74c3c; z-index: 9999; color: white; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
    <div class="display-3 mb-4"><i class="fas fa-exclamation-triangle"></i></div>
    <h1 class="display-3 fw-bold">{{ _('QOIDABUZARLIK!') }}</h1>
    <h3 class="mb-4">{{ _('Siz test oynasidan chiqdingiz!') }}</h3>
    <div class="mb-4">
        <p class="h5 mb-3">{{ _('Testni davom ettirish uchun nazoratchi parolini kiriting:') }}</p>
        <div class="input-group justify-content-center" style="max-width: 300px; margin: 0 auto;">
            <input type="password" id="unlock-password" class="form-control" placeholder="{{ _('Parol') }}"
                autocomplete="new-password" name="supervisor_unlock_code">
            <button class="btn btn-dark" onclick="checkUnlock()">{{ _('Ochish') }}</button>
        </div>
        <div id="unlock-error" class="text-white mt-2 small" style="display:none;">{{ _('Noto\'g\'ri parol!') }}</div>
    </div>
</div>

<!-- Start Overlay for Audio Permission & Grace Period -->
<!-- Start Overlay for Audio Permission & Grace Period - ONLY ON FIRST Q -->
{% if current <= 1 and is_protected %} <div id="start-overlay"
    style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); z-index: 9998; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; backdrop-filter: blur(5px);">
    <div class="card p-5 border-0 shadow-xl" style="max-width: 500px;">
        <div class="mb-4 text-primary">
            <i class="fas fa-shield-alt fa-4x"></i>
        </div>
        <h2 class="fw-bold mb-3">{{ _('Testni boshlash') }}</h2>
        <p class="text-muted mb-4">{{ _('Diqqat! Test "Himoyalangan rejimda" o\'tkaziladi. Test vaqtida oynadan chiqmang
            yoki boshqa ilovalarga o\'tmang, aks holda bu qoidabuzarlik deb hisoblanadi.') }}</p>
        <button class="btn btn-primary btn-lg shadow-lg px-5 py-3" onclick="startTest()">
            <i class="fas fa-play me-2"></i> {{ _('Testni boshlash') }}
        </button>
    </div>
    </div>
    {% endif %}

    <script>
        // Configuration
        const IS_PROTECTED = {{ 'true' if is_protected else 'false' }};
        // Enable protection immediately if it's protected and NOT the first question (handled by JS logic)
        // Or if first question, wait for start.
        const CURRENT_Q = {{ current }};

        // If Q == 1, wait for "Start Test" button.
        // If Q > 1, start with a 3-second grace period to allow session/page stability.
        let protectionEnabled = false;

        if (IS_PROTECTED && CURRENT_Q > 1) {
            console.log("Q > 1 detected. Arming protection in 3s...");
            setTimeout(() => {
                // Only arm if we are not already displaying a violation
                const overlay = document.getElementById('violation-overlay');
                if (protectionEnabled === false && overlay && overlay.style.display !== 'flex') {
                    protectionEnabled = true;
                    console.log("Protection armed automatically.");
                }
            }, 3000);
        }

        // Disable protection when intentional navigation starts
        function disableProtection() {
            protectionEnabled = false;
            console.log("Protection disabled for navigation.");
        }

        // Add listeners to all navigation links
        document.querySelectorAll('a[href*="/student/navigate"], a[href*="/student/jump"]').forEach(link => {
            link.addEventListener('click', disableProtection);
        });

        // Also handle the finish button in the modal
        const finishBtn = document.querySelector('a[href*="direction=finish"]');
        if (finishBtn) finishBtn.addEventListener('click', disableProtection);

        // Audio Context
        let audioCtx = null;

        function startTest() {
            // Hide overlay immediately
            const overlay = document.getElementById('start-overlay');
            if (overlay) overlay.style.display = 'none';

            // Request Fullscreen
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(e => {
                    console.error("FS error:", e);
                });
            }

            // Try to unlock audio
            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
            } catch (e) {
                console.log("Audio init warning:", e);
            }

            // Arm protection with delay
            if (IS_PROTECTED) {
                console.log("Arming protection in 2s...");
                setTimeout(() => {
                    protectionEnabled = true;
                    console.log("Protection armed.");
                }, 2000);
            }
        }

        // Fullscreen Change Detection
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && protectionEnabled) {
                triggerViolation('Fullscreen-Exit');
            }
        });

        // ----------- ANTI-CHEAT LOGIC -----------

        function playWarningSound() {
            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtx.state === 'suspended') audioCtx.resume();

                const oscillator1 = audioCtx.createOscillator();
                const oscillator2 = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator1.type = 'sawtooth';
                oscillator1.frequency.setValueAtTime(800, audioCtx.currentTime);
                oscillator1.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.5);

                oscillator2.type = 'square';
                oscillator2.frequency.setValueAtTime(400, audioCtx.currentTime);
                oscillator2.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.5);

                oscillator1.connect(gainNode);
                oscillator2.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator1.start();
                oscillator2.start();

                gainNode.gain.setValueAtTime(0.6, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.6, audioCtx.currentTime + 1.5);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 2);

                oscillator1.stop(audioCtx.currentTime + 2);
                oscillator2.stop(audioCtx.currentTime + 2);
            } catch (e) {
                console.error("Audio error:", e);
            }
        }

        function checkUnlock() {
            const pwd = document.getElementById('unlock-password').value;
            const err = document.getElementById('unlock-error');

            fetch('/student/verify_unlock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: pwd })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('violation-overlay').style.display = 'none';
                        document.getElementById('unlock-password').value = '';
                        if (err) err.style.display = 'none';
                        // Optional: reload or just keep going
                    } else {
                        if (err) err.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function triggerViolation(type = 'Blur/Visibility') {
            if (!protectionEnabled) return;

            // Show violation overlay immediately on client
            const overlay = document.getElementById('violation-overlay');
            if (overlay) overlay.style.display = 'flex';

            playWarningSound();

            // Report to server with type
            fetch('/student/report_violation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: type })
            });
        }

        document.addEventListener('visibilitychange', () => {
            if (document.hidden && protectionEnabled) {
                console.log("Violation: visibilitychange");
                triggerViolation('Visibility-Changed');
            }
        });

        window.addEventListener('blur', () => {
            if (protectionEnabled) {
                console.log("Violation: blur");
                document.body.style.filter = "blur(20px)";
                triggerViolation('Window-Blur');
            }
        });

        window.addEventListener('focus', () => {
            document.body.style.filter = "none";
        });

        // Anti-Screenshot & Keys
        document.addEventListener('keyup', (e) => {
            if (protectionEnabled) {
                if (e.key === 'PrintScreen' || e.keyCode === 44) {
                    navigator.clipboard.writeText("No screenshots!");
                    triggerViolation();
                }
                if (e.metaKey && e.shiftKey && (e.key === '3' || e.key === '4' || e.key === '5')) {
                    triggerViolation();
                }
            }
        });

        document.addEventListener('contextmenu', event => {
            if (protectionEnabled) event.preventDefault();
        });

        document.onkeydown = function (e) {
            if (!protectionEnabled) return true;
            // F12, Ctrl+Shift+I/J/C, Ctrl+U
            if (e.keyCode == 123) return false;
            if (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74 || e.keyCode == 67)) return false;
            if (e.ctrlKey && e.keyCode == 85) return false;
        }

        // Standard Logic
        function submitAnswer(questionId, answer) {
            fetch('/student/answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question_id: questionId, answer: answer })
            });
        }

        function toggleMark(questionId) {
            const btn = document.getElementById('mark-btn');
            const isMarked = btn.classList.contains('btn-warning');
            const newMarked = !isMarked;

            fetch('/student/mark_question', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question_id: parseInt(questionId), marked: newMarked })
            }).then(() => {
                // Update UI visually
                if (newMarked) {
                    btn.classList.remove('btn-outline-warning');
                    btn.classList.add('btn-warning');
                    btn.querySelector('i').classList.remove('far');
                    btn.querySelector('i').classList.add('fas');
                } else {
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-outline-warning');
                    btn.querySelector('i').classList.remove('fas');
                    btn.querySelector('i').classList.add('far');
                }
                // Optional: sync map without reload? 
                // For now, reload to see map changes or just leave it for next/prev.
                // Re-rendering map client side is complex, let's keep it simple.
            });
        }

        // Timer configuration (30 minutes)
        const TEST_DURATION = 30 * 60; // 1800 seconds
        const startTimePayload = {{ session.get('start_time', 0) }};
        const startTimeC = startTimePayload ? startTimePayload * 1000 : Date.now();

        function updateTimer() {
            const now = Date.now();
            const diffInSeconds = Math.floor((now - startTimeC) / 1000);
            const remaining = TEST_DURATION - diffInSeconds;

            if (remaining <= 0) {
                const timerEl = document.getElementById('timer');
                if (timerEl) timerEl.textContent = "00:00";
                // Auto-submit when time is up
                window.location.href = "{{ url_for('student.navigate', direction='finish', force=1) }}";
                return;
            }

            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            const timerEl = document.getElementById('timer');
            if (timerEl) {
                timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                if (remaining < 60) {
                    timerEl.classList.remove('text-primary');
                    timerEl.classList.add('text-danger');
                }
            }
        }

        updateTimer();
        setInterval(updateTimer, 1000);



    </script>
    {% endblock %}