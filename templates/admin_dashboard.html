{% extends "base.html" %}

{% block extra_css %}
<!-- Chart.js is required for charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .stat-card {
        border-radius: 1rem;
        border: none;
        transition: transform 0.2s;
        overflow: hidden;
        position: relative;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-card .card-body {
        position: relative;
        z-index: 2;
    }

    .stat-card .icon-bg {
        position: absolute;
        right: -10px;
        bottom: -10px;
        font-size: 5rem;
        opacity: 0.15;
        z-index: 1;
        transform: rotate(-15deg);
    }

    .bg-gradient-primary {
        background: linear-gradient(45deg, #4e73df, #224abe);
        color: white;
    }

    .bg-gradient-success {
        background: linear-gradient(45deg, #1cc88a, #13855c);
        color: white;
    }

    .bg-gradient-info {
        background: linear-gradient(45deg, #36b9cc, #258391);
        color: white;
    }

    .bg-gradient-warning {
        background: linear-gradient(45deg, #f6c23e, #dda20a);
        color: white;
    }

    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }

    .table-custom tr td {
        vertical-align: middle;
    }

    .avatar-circle {
        width: 40px;
        height: 40px;
        background-color: #e2e8f0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #475569;
    }

    .bg-soft-danger {
        background: rgba(239, 68, 68, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold mb-1">{{ _('Admin Dashboard') }}</h2>
            <p class="text-muted">{{ _('Tizim holati va statistika') }}</p>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="row mb-4">
        <!-- Jami Savollar -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card bg-gradient-warning h-100 shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-uppercase mb-1 opacity-75">{{ _('Jami Savollar') }}</div>
                            <div class="h3 mb-0 fw-bold">{{ total_questions }}</div>
                            <div class="mt-2 text-xs opacity-75">{{ _('Barcha fanlar') }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-question-circle fa-2x"></i>
                        </div>
                    </div>
                    <i class="fas fa-question icon-bg"></i>
                </div>
            </div>
        </div>

        <!-- Fanlar -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card bg-gradient-success h-100 shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-uppercase mb-1 opacity-75">{{ _('Fanlar') }}</div>
                            <div class="h3 mb-0 fw-bold">{{ subjects|length }}</div>
                            <div class="mt-2 text-xs opacity-75">{{ subjects|map(attribute='name')|join(', ') }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-book-open fa-2x"></i>
                        </div>
                    </div>
                    <i class="fas fa-book icon-bg"></i>
                </div>
            </div>
        </div>

        <!-- Natijalar -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card bg-gradient-primary h-100 shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-uppercase mb-1 opacity-75">{{ _('Natijalar') }}</div>
                            <div class="h3 mb-0 fw-bold">{{ total_results }}</div>
                            <div class="mt-2 text-xs opacity-75">{{ _('Topshirilgan testlar') }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                    </div>
                    <i class="fas fa-chart-bar icon-bg"></i>
                </div>
            </div>
        </div>

        <!-- O'zlashtirish (Pass Rate) -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card bg-gradient-info h-100 shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-uppercase mb-1 opacity-75">{{ _('O\'zlashtirish') }}</div>
                            <div class="h3 mb-0 fw-bold">{{ "%.0f"|format(pass_rate) }}%</div>
                            <div class="mt-2 text-xs opacity-75">{{ _('70%% dan yuqori natijalar') }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-graduation-cap fa-2x"></i>
                        </div>
                    </div>
                    <i class="fas fa-award icon-bg"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts & Difficult Questions Row -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header py-3 bg-white d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 fw-bold text-primary">{{ _('Testlar Statistikasi') }}</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header py-3 bg-white d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 fw-bold text-primary">{{ _('Eng Qiyin Savollar (Top 5)') }}</h6>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for dq in difficult_questions %}
                        <li class="list-group-item py-3">
                            <div class="small fw-bold text-dark mb-1">{{ dq.text }}</div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-soft-danger text-danger border-0 small">{{ dq.subject }}</span>
                                <span class="text-danger small fw-bold"><i
                                        class="fas fa-exclamation-triangle me-1"></i>{{ "%.0f"|format(dq.fail_rate) }}%
                                    xato</span>
                            </div>
                            <div class="progress mt-2" style="height: 4px;">
                                <div class="progress-bar bg-danger" style="width: {{ dq.fail_rate }}%"></div>
                            </div>
                        </li>
                        {% else %}
                        <li class="list-group-item text-center py-4 text-muted small">
                            {{ _('Ma\'lumotlar yetarli emas') }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Results Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header py-3 bg-white border-0 d-flex justify-content-between align-items-center">
                    <h5 class="m-0 fw-bold text-dark"><i class="fas fa-table me-2 text-muted"></i>{{ _('Oxirgi Test
                        Natijalari') }}
                    </h5>
                    <a href="{{ url_for('admin.results') }}" class="btn btn-sm btn-outline-primary rounded-pill px-4">{{
                        _('Barchasi') }}</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-custom align-middle mb-0">
                        <thead class="bg-light text-muted">
                            <tr>
                                <th class="ps-4">{{ _('O\'quvchi') }}</th>
                                <th>{{ _('Fan') }}</th>
                                <th>{{ _('Sinf') }}</th>
                                <th>{{ _('Ball') }}</th>
                                <th>{{ _('Foiz') }}</th>
                                <th>{{ _('Sana') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in recent_results %}
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle me-3">
                                            {{ result.full_name[:1] }}
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">{{ result.full_name }}</div>
                                            <div class="small text-muted">ID: #{{ result.id }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge bg-light text-dark border">{{ result.subject.name }}</span></td>
                                <td>{{ result.grade }}-{{ result.class_number }}</td>
                                <td>
                                    <span class="fw-bold">{{ result.score }}/{{ result.total_questions }}</span>
                                </td>
                                <td>
                                    {% if result.percentage >= 85 %}
                                    <span class="badge bg-success rounded-pill px-3">{{ _('A\'lo') }} ({{
                                        "%.0f"|format(result.percentage) }}%)</span>
                                    {% elif result.percentage >= 70 %}
                                    <span class="badge bg-info rounded-pill px-3">{{ _('Yaxshi') }} ({{
                                        "%.0f"|format(result.percentage) }}%)</span>
                                    {% elif result.percentage >= 60 %}
                                    <span class="badge bg-warning rounded-pill px-3">{{ _('Qoniqarli') }} ({{
                                        "%.0f"|format(result.percentage) }}%)</span>
                                    {% else %}
                                    <span class="badge bg-danger rounded-pill px-3">{{ _('Yomon') }} ({{
                                        "%.0f"|format(result.percentage) }}%)</span>
                                    {% endif %}
                                </td>
                                <td class="text-muted small">
                                    <i class="far fa-calendar-alt me-1"></i> {{ result.test_date.strftime('%Y-%m-%d
                                    %H:%M') }}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted">{{ _('Hozircha natijalar mavjud
                                    emas') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const subjects = {{ subject_names | tojson
    }};
    const resultCounts = {{ result_counts | tojson }};

    const ctxBar = document.getElementById('barChart').getContext('2d');
    new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: subjects,
            datasets: [{
                label: '{{ _("Topshirilgan Testlar") }}',
                data: resultCounts,
                backgroundColor: 'rgba(78, 115, 223, 0.8)',
                hoverBackgroundColor: '#2e59d9',
                borderColor: '#4e73df',
                borderWidth: 1,
                borderRadius: 8
            }]
        },
        options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    padding: 12,
                    cornerRadius: 8
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1, color: '#858796' },
                    grid: { borderDash: [2], drawBorder: false, color: '#e3e6f0' }
                },
                x: {
                    ticks: { color: '#858796' },
                    grid: { display: false, drawBorder: false }
                }
            }
        }
    });
    });
</script>
{% endblock %}