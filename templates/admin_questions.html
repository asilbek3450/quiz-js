{% extends "base.html" %}

{% block title %}{{ _('Savollar boshqaruvi') }} - Admin{% endblock %}

{% block extra_js %}
<script>
    function translateAllMissing() {
        const btn = document.getElementById('translate-btn');
        const originalContent = btn.innerHTML;

        // Get current filters
        const urlParams = new URLSearchParams(window.location.search);
        const subject_id = urlParams.get('subject_id');
        const grade = urlParams.get('grade');
        const quarter = urlParams.get('quarter');

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> {{ _("Tarjimada...") }}';

        function processBatch() {
            console.log("Processing translation batch...");
            fetch('{{ url_for("admin.translate_missing_questions") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ subject_id, grade, quarter })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        if (data.remaining > 0) {
                            btn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i> ${data.remaining} {{ _("ta qoldi...") }}`;
                            processBatch(); // Continue next batch
                        } else {
                            btn.innerHTML = '<i class="fas fa-check me-2"></i> {{ _("Tayyor!") }}';
                            setTimeout(() => location.reload(), 1000);
                        }
                    } else {
                        alert("Error: " + data.error);
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                    }
                })
                .catch(err => {
                    console.error(err);
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                });
        }

        processBatch();
    }
</script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4 animate-fade-in-up">
        <div class="col-md-8">
            <h2 class="fw-bold text-gradient"><i class="fas fa-question-circle me-2"></i> {{ _('Savollar boshqaruvi') }}
            </h2>
            <p class="text-muted">{{ _('Test savollarini yaratish va boshqarish bo\'limi') }}</p>
        </div>
        <div class="col-md-4 text-md-end">
            <button type="button" class="btn btn-warning me-2" id="translate-btn" onclick="translateAllMissing()">
                <i class="fas fa-language me-2"></i> {{ _('Tarjima qilish') }}
            </button>
            <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#importModal">
                <i class="fas fa-file-excel me-2"></i> {{ _('Excel yuklash') }}
            </button>
            <a href="{{ url_for('admin.question_add') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i> {{ _('Yangi savol') }}
            </a>
        </div>
    </div>
    <div class="card shadow-sm border-0 animate-fade-in-up" style="border-radius: 12px; animation-delay: 0.1s;">
        <div class="card-body p-4">
            <!-- Filtrlar -->
            <form method="GET" class="mb-4">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-book text-primary"></i> {{ _('Fan') }}
                        </label>
                        <select name="subject_id" class="form-select" onchange="this.form.submit()">
                            <option value="">{{ _('Barchasi') }}</option>
                            {% for subject in subjects %}
                            <option value="{{ subject.id }}" {% if request.args.get('subject_id')|int==subject.id
                                %}selected{% endif %}>
                                {{ subject.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-users text-success"></i> {{ _('Sinf') }}
                        </label>
                        <select name="grade" class="form-select" onchange="this.form.submit()">
                            <option value="">{{ _('Barchasi') }}</option>
                            {% for g in range(5, 12) %}
                            <option value="{{ g }}" {% if request.args.get('grade')|int==g %}selected{% endif %}>
                                {{ g }}-{{ _('sinf') }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-calendar text-warning"></i> {{ _('Chorak') }}
                        </label>
                        <select name="quarter" class="form-select" onchange="this.form.submit()">
                            <option value="">{{ _('Barchasi') }}</option>
                            {% for q in range(1, 5) %}
                            <option value="{{ q }}" {% if request.args.get('quarter')|int==q %}selected{% endif %}>
                                {{ q }}-{{ _('chorak') }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-file-alt text-info"></i> {{ _('Turi') }}
                        </label>
                        <select name="is_control_work" class="form-select" onchange="this.form.submit()">
                            <option value="">{{ _('Barchasi') }}</option>
                            <option value="1" {% if request.args.get('is_control_work')=='1' %}selected{% endif %}>{{
                                _('Nazorat ishi') }}</option>
                            <option value="0" {% if request.args.get('is_control_work')=='0' %}selected{% endif %}>{{
                                _('Oddiy test') }}</option>
                        </select>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-12">
                        <div class="input-group">
                            <span class="input-group-text bg-light text-primary border-end-0">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" name="search" class="form-control border-start-0 ps-0"
                                placeholder="{{ _('Savol matnidan qidirish...') }}"
                                value="{{ request.args.get('search', '') }}">
                            <button class="btn btn-primary" type="submit">
                                {{ _('Qidirish') }}
                            </button>
                            {% if request.args.get('search') %}
                            <a href="{{ url_for('admin.questions', subject_id=request.args.get('subject_id'), grade=request.args.get('grade'), quarter=request.args.get('quarter'), is_control_work=request.args.get('is_control_work')) }}"
                                class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>

            <!-- Statistika -->
            <div class="alert alert-info mb-4 border-0 shadow-sm d-flex align-items-center">
                <i class="fas fa-info-circle fa-2x me-3 opacity-75"></i>
                <div>
                    <strong>{{ _('Ko\'rsatilmoqda') }}:</strong> <span
                        class="badge bg-white text-primary border ms-1">{{ questions|length }} ta savol</span>
                    <span class="text-muted ms-2">({{ pagination.page }}-{{ _('sahifa') }}, {{ pagination.per_page }} {{
                        _('tadan') }})</span>
                    <br>
                    <strong>{{ _('Jami') }}:</strong> <span class="badge bg-white text-info border ms-1">{{
                        pagination.total }} ta savol</span>
                    {% if request.args.get('subject_id') or request.args.get('grade') or request.args.get('quarter') or
                    request.args.get('search') or request.args.get('is_control_work') %}
                    <span class="badge bg-warning text-dark ms-2"><i class="fas fa-filter"></i> {{ _('Filtrlangan')
                        }}</span>
                    {% endif %}
                </div>
            </div>

            <!-- Savollar jadvali -->
            {% if questions %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px;" class="text-center">#</th>
                            <th>{{ _('Savol') }}</th>
                            <th style="width: 120px;">{{ _('Fan') }}</th>
                            <th style="width: 80px;" class="text-center">{{ _('Sinf') }}</th>
                            <th style="width: 90px;" class="text-center">{{ _('Chorak') }}</th>
                            <th style="width: 100px;" class="text-center">{{ _('To\'g\'ri') }}</th>
                            <th style="width: 120px;" class="text-center">{{ _('Amallar') }}</th>
                        </tr>
                    </thead>
                    <tbody class="border-top-0">
                        {% for question in questions %}
                        <tr>
                            <td class="text-center text-muted fw-bold">{{ loop.index + (pagination.page - 1) *
                                pagination.per_page }}</td>
                            <td>
                                <div class="text-wrap fw-semibold mb-2" style="max-width: 500px;"
                                    title="{{ question.question_text }}">
                                    {{ question.question_text }}
                                </div>
                                <div class="row gx-2 gy-1" style="font-size: 0.85rem;">
                                    <div class="col-6">
                                        <div class="border rounded bg-light px-2 py-1 text-dark shadow-sm text-truncate"
                                            title="{{ question.option_a }}"><strong class="text-primary">A:</strong> {{
                                            question.option_a }}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded bg-light px-2 py-1 text-dark shadow-sm text-truncate"
                                            title="{{ question.option_b }}"><strong class="text-success">B:</strong> {{
                                            question.option_b }}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded bg-light px-2 py-1 text-dark shadow-sm text-truncate"
                                            title="{{ question.option_c }}"><strong class="text-warning">C:</strong> {{
                                            question.option_c }}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded bg-light px-2 py-1 text-dark shadow-sm text-truncate"
                                            title="{{ question.option_d }}"><strong class="text-danger">D:</strong> {{
                                            question.option_d }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-primary rounded-pill px-3 py-2 shadow-sm">{{ question.subject.name
                                    }}</span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-success rounded-pill px-3 py-2 shadow-sm">{{ question.grade
                                    }}-sinf</span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-warning text-dark rounded-pill px-3 py-2 shadow-sm">{{
                                    question.quarter }}-ch</span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-danger rounded-pill px-3 py-2 shadow-sm fs-6">{{
                                    question.correct_answer }}</span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm shadow-sm" role="group">
                                    <a href="{{ url_for('admin.question_edit', id=question.id) }}"
                                        class="btn btn-light border" data-bs-toggle="tooltip"
                                        title="{{ _('Tahrirlash') }}">
                                        <i class="fas fa-edit text-primary"></i>
                                    </a>
                                    <button type="button" class="btn btn-light border text-danger"
                                        onclick="deleteQuestion({{ question.id }}, this)" data-bs-toggle="tooltip"
                                        title="{{ _('O\'chirish') }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- AJAX Deletion Script -->
            <script>
                function deleteQuestion(id, btn) {
                    if (confirm("{{ _('Savolni o\'chirishni tasdiqlaysizmi?') }}")) {
                        // Change icon to spinner
                        const icon = btn.querySelector('i');
                        const originalClass = icon.className;
                        icon.className = 'fas fa-spinner fa-spin';
                        btn.disabled = true;

                        fetch(`{{ url_for('admin.question_delete', id=0) }}`.replace('0', id), {
                            method: 'GET',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Find the row and fade it out
                                    const row = btn.closest('tr');
                                    row.style.transition = 'opacity 0.4s ease';
                                    row.style.opacity = '0';
                                    setTimeout(() => row.remove(), 400);
                                } else {
                                    alert("{{ _('Xatolik yuz berdi') }}");
                                    icon.className = originalClass;
                                    btn.disabled = false;
                                }
                            })
                            .catch(err => {
                                console.error(err);
                                alert("{{ _('Tarmoq xatosi yoki server javob bermadi') }}");
                                icon.className = originalClass;
                                btn.disabled = false;
                            });
                    }
                }
            </script>

            <!-- Pagination -->
            {% if pagination.pages > 1 %}
            <nav aria-label="Sahifalar navigatsiyasi" class="mt-4">
                <ul class="pagination justify-content-center">
                    <!-- Oldingi sahifa -->
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link"
                            href="{% if pagination.has_prev %}{{ url_for('admin.questions', page=pagination.prev_num, subject_id=request.args.get('subject_id'), grade=request.args.get('grade'), quarter=request.args.get('quarter'), is_control_work=request.args.get('is_control_work'), search=request.args.get('search')) }}{% else %}#{% endif %}">
                            <i class="fas fa-chevron-left"></i> {{ _('Oldingi') }}
                        </a>
                    </li>

                    <!-- Sahifa raqamlari -->
                    {% for page_num in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2)
                    %}
                    {% if page_num %}
                    <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                        <a class="page-link"
                            href="{{ url_for('admin.questions', page=page_num, subject_id=request.args.get('subject_id'), grade=request.args.get('grade'), quarter=request.args.get('quarter'), is_control_work=request.args.get('is_control_work'), search=request.args.get('search')) }}">
                            {{ page_num }}
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    {% endfor %}

                    <!-- Keyingi sahifa -->
                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link"
                            href="{% if pagination.has_next %}{{ url_for('admin.questions', page=pagination.next_num, subject_id=request.args.get('subject_id'), grade=request.args.get('grade'), quarter=request.args.get('quarter'), is_control_work=request.args.get('is_control_work'), search=request.args.get('search')) }}{% else %}#{% endif %}">
                            {{ _('Keyingi') }} <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}
            {% else %}
            <div class="text-center py-5">
                <div class="display-1 text-muted mb-3 opacity-25 animate-fade-in-up">
                    <i class="fas fa-box-open"></i>
                </div>
                <h4 class="text-secondary fw-bold">{{ _('Savollar topilmadi') }}</h4>
                <p class="text-muted mb-4">{{ _('Tanlangan filtrlar bo\'yicha savollar mavjud emas yoxud hali savol
                    kiritilmagan.') }}</p>
                <a href="{{ url_for('admin.question_add') }}"
                    class="btn btn-primary btn-lg shadow-sm rounded-pill px-4">
                    <i class="fas fa-plus me-2"></i> {{ _('Birinchi savolni qo\'shish') }}
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Savollar statistikasi -->
    <div class="row mt-4 animate-fade-in-up" style="animation-delay: 0.2s;">
        <div class="col-md-12">
            <div class="card shadow-sm border-0" style="border-radius: 12px;">
                <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                    <h5 class="mb-0 fw-bold text-dark">
                        <i class="fas fa-chart-pie text-primary me-2"></i> {{ _('Savollar statistikasi') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        {% for subject in subjects %}
                        <div class="col-md-6 mb-3">
                            <h6 class="fw-bold">{{ subject.name }}</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered table-hover align-middle mb-0 text-center">
                                    <thead class="table-light text-muted">
                                        <tr>
                                            <th>{{ _('Sinf') }}</th>
                                            <th>1-{{ _('ch') }}</th>
                                            <th>2-{{ _('ch') }}</th>
                                            <th>3-{{ _('ch') }}</th>
                                            <th>4-{{ _('ch') }}</th>
                                            <th class="bg-light">{{ _('Jami') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody class="border-top-0">
                                        {% set grades = subject.grades.split(',') %}
                                        {% for grade in grades %}
                                        <tr>
                                            <td class="fw-bold text-muted">{{ grade }}-sinf</td>
                                            {% for quarter in range(1, 5) %}
                                            {% set count = all_questions|selectattr('subject_id', 'equalto',
                                            subject.id)|selectattr('grade', 'equalto', grade|int)|selectattr('quarter',
                                            'equalto', quarter)|list|length %}
                                            <td
                                                class="fw-semibold {% if count >= 200 %}text-success bg-success bg-opacity-10{% elif count >= 20 %}text-warning bg-warning bg-opacity-10{% else %}text-danger bg-danger bg-opacity-10{% endif %}">
                                                {{ count }}
                                            </td>
                                            {% endfor %}
                                            {% set total = all_questions|selectattr('subject_id', 'equalto',
                                            subject.id)|selectattr('grade', 'equalto', grade|int)|list|length %}
                                            <td class="fw-bold bg-light">{{ total }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="alert bg-light border-0 shadow-sm mb-0 mt-4 d-flex align-items-center rounded-3">
                        <i class="fas fa-info-circle fa-2x text-primary opacity-50 me-3"></i>
                        <div>
                            <strong class="text-dark">{{ _('Eslatma') }}:</strong>
                            <span class="badge bg-success bg-opacity-10 text-success border border-success ms-2">200+ {{
                                _('savol (yetarli)') }}</span>
                            <span class="badge bg-warning bg-opacity-10 text-warning border border-warning ms-2">20-199
                                {{ _('savol') }}</span>
                            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger ms-2">
                                < 20 {{ _('savol') }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="fas fa-file-excel text-success me-2"></i> {{ _('Savollarni
                    yuklash') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.import_questions') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> {{ _('Fayl quyidagi ustunlardan iborat bo\'lishi
                        shart:') }}<br>
                        <strong>Question, A, B, C, D, Correct</strong>
                        <div class="mt-2">
                            <a href="{{ url_for('admin.download_template') }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-download me-1"></i> {{ _('Namuna yuklab olish') }}
                            </a>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">{{ _('Fan') }}</label>
                        <select name="subject_id" class="form-select" required>
                            {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label fw-bold">{{ _('Sinf') }}</label>
                            <select name="grade" class="form-select" required>
                                {% for g in range(5, 12) %}
                                <option value="{{ g }}">{{ g }}-sinf</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-bold">{{ _('Chorak') }}</label>
                            <select name="quarter" class="form-select" required>
                                {% for q in range(1, 5) %}
                                <option value="{{ q }}">{{ q }}-chorak</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">{{ _('Excel fayl') }} (.xlsx)</label>
                        <input type="file" name="file" class="form-control" accept=".xlsx, .xls" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">{{ _('Bekor qilish') }}</button>
                    <button type="submit" class="btn btn-success">{{ _('Yuklash') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}