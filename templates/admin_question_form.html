{% extends "base.html" %}

{% block title %}{% if question %}{{ _('Savolni tahrirlash') }}{% else %}{{ _('Yangi savol') }}{% endif %} - Admin{%
endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header bg-gradient text-white"
                    style="background: linear-gradient(135deg, #4f46e5, #06b6d4);">
                    <h3 class="mb-0">
                        <i class="fas fa-{% if question %}edit{% else %}plus{% endif %} me-2"></i>
                        {% if question %}{{ _('Savolni tahrirlash') }}{% else %}{{ _('Yangi savol qo\'shish') }}{% endif
                        %}
                    </h3>
                </div>
                <div class="card-body p-4">
                    <form method="POST">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-book text-primary"></i> {{ _('Fan') }}
                                </label>
                                <select name="subject_id" class="form-select" required id="subjectSelect">
                                    {% for subject in subjects %}
                                    <option value="{{ subject.id }}" data-grades="{{ subject.grades }}" {% if question
                                        and question.subject_id==subject.id %}selected{% endif %}>
                                        {{ subject.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-users text-success"></i> {{ _('Sinf') }}
                                </label>
                                <select name="grade" class="form-select" required id="gradeSelect">
                                    {% for g in range(5, 10) %}
                                    <option value="{{ g }}" {% if question and question.grade==g %}selected{% endif %}>
                                        {{ g }}-{{ _('sinf') }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-calendar text-warning"></i> {{ _('Chorak') }}
                                </label>
                                <select name="quarter" class="form-select" required>
                                    {% for q in range(1, 5) %}
                                    <option value="{{ q }}" {% if question and question.quarter==q %}selected{% endif
                                        %}>
                                        {{ q }}-{{ _('chorak') }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-question-circle text-info"></i> {{ _('Savol matni') }}
                            </label>
                            <textarea name="question_text" class="form-control" rows="3" required
                                placeholder="{{ _('Savolni kiriting...') }}">{% if question %}{{ question.question_text }}{% endif %}</textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <span class="badge bg-primary">A</span> {{ _('Variant A') }}
                                </label>
                                <input type="text" name="option_a" class="form-control" required
                                    placeholder="{{ _('A varianti...') }}"
                                    value="{% if question %}{{ question.option_a }}{% endif %}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <span class="badge bg-success">B</span> {{ _('Variant B') }}
                                </label>
                                <input type="text" name="option_b" class="form-control" required
                                    placeholder="{{ _('B varianti...') }}"
                                    value="{% if question %}{{ question.option_b }}{% endif %}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <span class="badge bg-warning">C</span> {{ _('Variant C') }}
                                </label>
                                <input type="text" name="option_c" class="form-control" required
                                    placeholder="{{ _('C varianti...') }}"
                                    value="{% if question %}{{ question.option_c }}{% endif %}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <span class="badge bg-danger">D</span> {{ _('Variant D') }}
                                </label>
                                <input type="text" name="option_d" class="form-control" required
                                    placeholder="{{ _('D varianti...') }}"
                                    value="{% if question %}{{ question.option_d }}{% endif %}">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-check-circle text-success"></i> {{ _('To\'g\'ri javob') }}
                            </label>
                            <div class="btn-group w-100" role="group">
                                {% for opt in ['A', 'B', 'C', 'D'] %}
                                <input type="radio" class="btn-check" name="correct_answer" id="answer{{ opt }}"
                                    value="{{ opt }}" {% if question and question.correct_answer==opt %}checked{% endif
                                    %} {% if not question and opt=='A' %}checked{% endif %} required>
                                <label class="btn btn-outline-success" for="answer{{ opt }}">
                                    <i class="fas fa-check"></i> {{ opt }}
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-fill">
                                <i class="fas fa-save me-2"></i>
                                {% if question %}{{ _('O\'zgarishlarni saqlash') }}{% else %}{{ _('Savolni qo\'shish')
                                }}{% endif %}
                            </button>
                            <a href="{{ url_for('admin_questions') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i> {{ _('Bekor qilish') }}
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Sinflarni fan bo'yicha filtrlash
    document.getElementById('subjectSelect').addEventListener('change', function () {
        const selectedOption = this.options[this.selectedIndex];
        const allowedGrades = selectedOption.dataset.grades.split(',').map(g => parseInt(g));
        const gradeSelect = document.getElementById('gradeSelect');

        Array.from(gradeSelect.options).forEach(option => {
            const grade = parseInt(option.value);
            if (allowedGrades.includes(grade)) {
                option.style.display = '';
                option.disabled = false;
            } else {
                option.style.display = 'none';
                option.disabled = true;
            }
        });

        // Agar tanlangan sinf ruxsat etilmagan bo'lsa, birinchi ruxsat etilgan sinfni tanlash
        if (!allowedGrades.includes(parseInt(gradeSelect.value))) {
            gradeSelect.value = allowedGrades[0];
        }
    });

    // Sahifa yuklanganda filtrlash
    document.getElementById('subjectSelect').dispatchEvent(new Event('change'));
</script>
{% endblock %}